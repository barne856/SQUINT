# Use a Windows Server Core base image
FROM mcr.microsoft.com/windows/servercore:ltsc2022

# Arguments for versions
ARG COMPILER_VERSION="2022"
ARG CMAKE_VERSION="3.29.5"
ARG INTEL_MKL_VERSION="2024.0.0"
ARG INTEL_FORTRAN_VERSION="2024.0.0"

# Set shell to PowerShell
SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]

# Download and install CMake
RUN Invoke-WebRequest -Uri "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}-windows-x86_64.msi" -OutFile cmake.msi; \
    Start-Process -FilePath msiexec.exe -ArgumentList "/i", "cmake.msi", "/quiet", "/qn", "/norestart" -NoNewWindow -Wait; \
    Remove-Item cmake.msi

# Download and install Git
RUN Invoke-WebRequest -Uri "https://github.com/git-for-windows/git/releases/download/v2.38.1.windows.1/Git-2.38.1-64-bit.exe" -OutFile git-installer.exe; \
    Start-Process -FilePath .\git-installer.exe -ArgumentList "/VERYSILENT", "/NORESTART", "/NOCANCEL", "/SP-", "/CLOSEAPPLICATIONS", "/RESTARTAPPLICATIONS", "/COMPONENTS=icons,ext\reg\shellhere,assoc,assoc_sh" -NoNewWindow -Wait; \
    Remove-Item git-installer.exe

# Download and install Visual Studio Build Tools
RUN Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vs_buildtools.exe" -OutFile vs_buildtools.exe; \
    Start-Process -FilePath .\vs_buildtools.exe -ArgumentList "--quiet", "--wait", "--norestart", "--nocache", \
    "--installPath", "C:\BuildTools", \
    "--add", "Microsoft.VisualStudio.Workload.VCTools", \
    "--add", "Microsoft.VisualStudio.Component.VC.Tools.x86.x64", \
    "--add", "Microsoft.VisualStudio.Component.Windows10SDK.19041", \
    "--add", "Microsoft.VisualStudio.Component.VC.CMake.Project" -NoNewWindow -Wait; \
    Remove-Item .\vs_buildtools.exe

# Download and install Intel oneAPI Base Toolkit (includes MKL)
RUN Invoke-WebRequest -Uri "https://registrationcenter-download.intel.com/akdlm/IRC_NAS/b13e474d-2303-44ad-b52e-657c8960de1e/w_BaseKit_p_${INTEL_MKL_VERSION}_offline.exe" -OutFile "w_BaseKit_p_${INTEL_MKL_VERSION}_offline.exe"; \
    Start-Process -FilePath "w_BaseKit_p_${INTEL_MKL_VERSION}_offline.exe" -ArgumentList "-s --components=intel.oneapi.win.mkl.devel" -Wait; \
    Remove-Item "w_BaseKit_p_${INTEL_MKL_VERSION}_offline.exe"

# Download and install Intel Fortran Compiler
RUN Invoke-WebRequest -Uri "https://registrationcenter-download.intel.com/akdlm/IRC_NAS/b13e474d-2303-44ad-b52e-657c8960de1e/w_HPCKit_p_${INTEL_FORTRAN_VERSION}_offline.exe" -OutFile "w_HPCKit_p_${INTEL_FORTRAN_VERSION}_offline.exe"; \
    Start-Process -FilePath "w_HPCKit_p_${INTEL_FORTRAN_VERSION}_offline.exe" -ArgumentList "-s --components=intel.oneapi.win.ifort-compiler" -Wait; \
    Remove-Item "w_HPCKit_p_${INTEL_FORTRAN_VERSION}_offline.exe"

# Set up environment variables
RUN $vsPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\BuildTools"; \
    $intellPath = "${env:ProgramFiles(x86)}\Intel\oneAPI"; \
    setx PATH "$env:PATH;$vsPath\Common7\IDE\CommonExtensions\Microsoft\CMake\CMake\bin;$vsPath\VC\Tools\MSVC\14.38.33130\bin\Hostx64\x64;$intellPath\mkl\latest\bin\intel64;$intellPath\compiler\latest\windows\bin\intel64;${env:ProgramFiles}\Git\cmd" /M

# Set the entry point to PowerShell
ENTRYPOINT ["powershell.exe", "-NoLogo", "-ExecutionPolicy", "Bypass"]